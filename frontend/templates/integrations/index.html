{% extends "components/layout.html" %}

{% block title %}Integrations - LinkedEye-FinSpot{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <h1 class="page-title">Integrations Hub</h1>
        <p class="page-subtitle">Connect with monitoring tools, ticketing systems, and communication platforms</p>
    </div>
    <div class="page-header-right">
        <button class="btn btn-primary" onclick="showAddIntegration()">
            <i class="fas fa-plug"></i> Add Integration
        </button>
    </div>
</div>

<div class="integration-grid">
    <!-- LinkedEye Monitoring (Unified) -->
    <div class="integration-card featured" data-type="LINKEDEYE_MONITORING">
        <div class="integration-icon integration-linkedeye">
            <i class="fas fa-eye"></i>
        </div>
        <div class="integration-info">
            <h4>LinkedEye Monitoring</h4>
            <p>Unified Monitoring Hub</p>
        </div>
        <div class="integration-status" id="linkedeye-status">
            {% set le = integrations|selectattr('type', 'equalto', 'LINKEDEYE_MONITORING')|first %}
            {% if le and le.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Configured</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            <a href="{{ url_for('linkedeye_monitoring') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-cog"></i> Configure
            </a>
        </div>
    </div>

    <!-- Prometheus -->
    <div class="integration-card" data-type="PROMETHEUS">
        <div class="integration-icon integration-prometheus">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="integration-info">
            <h4>Prometheus</h4>
            <p>Metrics & Alerting</p>
        </div>
        <div class="integration-status" id="prometheus-status">
            {% set prom = integrations|selectattr('type', 'equalto', 'PROMETHEUS')|first %}
            {% if prom and prom.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if prom %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('PROMETHEUS', '{{ prom.id }}', '{{ prom.name }}', '{{ prom.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('prometheus')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('PROMETHEUS')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- Grafana -->
    <div class="integration-card" data-type="GRAFANA">
        <div class="integration-icon integration-grafana">
            <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="integration-info">
            <h4>Grafana</h4>
            <p>Dashboards & Visualization</p>
        </div>
        <div class="integration-status" id="grafana-status">
            {% set graf = integrations|selectattr('type', 'equalto', 'GRAFANA')|first %}
            {% if graf and graf.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if graf %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('GRAFANA', '{{ graf.id }}', '{{ graf.name }}', '{{ graf.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('grafana')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('GRAFANA')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- Slack -->
    <div class="integration-card" data-type="SLACK">
        <div class="integration-icon integration-slack">
            <i class="fab fa-slack"></i>
        </div>
        <div class="integration-info">
            <h4>Slack</h4>
            <p>Team Communication</p>
        </div>
        <div class="integration-status" id="slack-status">
            {% set slack = integrations|selectattr('type', 'equalto', 'SLACK')|first %}
            {% if slack and slack.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if slack %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('SLACK', '{{ slack.id }}', '{{ slack.name }}', '{{ slack.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('slack')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('SLACK')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- Alertmanager -->
    <div class="integration-card" data-type="ALERTMANAGER">
        <div class="integration-icon integration-alertmanager">
            <i class="fas fa-bell"></i>
        </div>
        <div class="integration-info">
            <h4>Alertmanager</h4>
            <p>Alert Management</p>
        </div>
        <div class="integration-status" id="alertmanager-status">
            {% set am = integrations|selectattr('type', 'equalto', 'ALERTMANAGER')|first %}
            {% if am and am.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if am %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('ALERTMANAGER', '{{ am.id }}', '{{ am.name }}', '{{ am.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('alertmanager')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('ALERTMANAGER')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- Grafana Loki -->
    <div class="integration-card" data-type="LOKI">
        <div class="integration-icon integration-loki">
            <i class="fas fa-scroll"></i>
        </div>
        <div class="integration-info">
            <h4>Grafana Loki</h4>
            <p>Log Aggregation</p>
        </div>
        <div class="integration-status" id="loki-status">
            {% set loki = integrations|selectattr('type', 'equalto', 'LOKI')|first %}
            {% if loki and loki.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if loki %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('LOKI', '{{ loki.id }}', '{{ loki.name }}', '{{ loki.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('loki')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('LOKI')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- StackStorm -->
    <div class="integration-card" data-type="STACKSTORM">
        <div class="integration-icon integration-stackstorm">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="integration-info">
            <h4>StackStorm</h4>
            <p>Event-Driven Automation</p>
        </div>
        <div class="integration-status" id="stackstorm-status">
            {% set st2 = integrations|selectattr('type', 'equalto', 'STACKSTORM')|first %}
            {% if st2 and st2.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if st2 %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('STACKSTORM', '{{ st2.id }}', '{{ st2.name }}', '{{ st2.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('stackstorm')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('STACKSTORM')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- PagerDuty -->
    <div class="integration-card" data-type="PAGERDUTY">
        <div class="integration-icon integration-pagerduty">
            <i class="fas fa-pager"></i>
        </div>
        <div class="integration-info">
            <h4>PagerDuty</h4>
            <p>Incident Response</p>
        </div>
        <div class="integration-status" id="pagerduty-status">
            {% set pd = integrations|selectattr('type', 'equalto', 'PAGERDUTY')|first %}
            {% if pd and pd.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if pd %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('PAGERDUTY', '{{ pd.id }}', '{{ pd.name }}', '{{ pd.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('pagerduty')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('PAGERDUTY')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- Jira -->
    <div class="integration-card" data-type="JIRA">
        <div class="integration-icon integration-jira">
            <i class="fab fa-jira"></i>
        </div>
        <div class="integration-info">
            <h4>Jira</h4>
            <p>Issue Tracking</p>
        </div>
        <div class="integration-status" id="jira-status">
            {% set jira = integrations|selectattr('type', 'equalto', 'JIRA')|first %}
            {% if jira and jira.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if jira %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('JIRA', '{{ jira.id }}', '{{ jira.name }}', '{{ jira.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('jira')">Test</button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('JIRA')">Setup</button>
            {% endif %}
        </div>
    </div>

    <!-- ServiceNow -->
    <div class="integration-card" data-type="SERVICENOW">
        <div class="integration-icon integration-servicenow">
            <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="integration-info">
            <h4>ServiceNow</h4>
            <p>ITSM Platform</p>
        </div>
        <div class="integration-status" id="servicenow-status">
            {% set snow = integrations|selectattr('type', 'equalto', 'SERVICENOW')|first %}
            {% if snow and snow.status == 'ACTIVE' %}
            <span class="badge badge-success">Connected</span>
            {% else %}
            <span class="badge badge-secondary">Not Connected</span>
            {% endif %}
        </div>
        <div class="integration-actions">
            {% if snow %}
            <button class="btn btn-secondary btn-sm"
                onclick="configureIntegration('SERVICENOW', '{{ snow.id }}', '{{ snow.name }}', '{{ snow.config | default('{}') | e }}')">Configure</button>
            <button class="btn btn-outline btn-sm" onclick="testIntegration('servicenow')">Test</button>
            <button class="btn btn-outline btn-sm" onclick="syncIntegration('servicenow')">
                <i class="fas fa-sync"></i> Sync
            </button>
            {% else %}
            <button class="btn btn-primary btn-sm" onclick="configureIntegration('SERVICENOW')">Setup</button>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list"></i> Active Integrations</h3>
    </div>
    <div class="card-body no-padding">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Last Sync</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for integration in integrations %}
                    <tr>
                        <td>{{ integration.name }}</td>
                        <td>{{ integration.type }}</td>
                        <td>
                            <span class="badge badge-{{ 'success' if integration.status == 'ACTIVE' else 'warning' }}">
                                {{ integration.status }}
                            </span>
                        </td>
                        <td>{{ integration.lastSyncAt or '-' }}</td>
                        <td>
                            <button class="btn-icon" title="Test"
                                onclick="testIntegrationById('{{ integration.id }}')"><i
                                    class="fas fa-sync"></i></button>
                            <button class="btn-icon" title="Edit"
                                onclick="editIntegration('{{ integration.id }}', '{{ integration.name }}', '{{ integration.type }}', '{{ integration.config | default('{}') | e }}')"><i
                                    class="fas fa-edit"></i></button>
                            <button class="btn-icon text-danger" title="Delete"
                                onclick="deleteIntegration('{{ integration.id }}')"><i
                                    class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No integrations configured</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Integration Modal -->
<div id="integrationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="integrationModalTitle">Add Integration</h3>
            <button class="modal-close" onclick="closeIntegrationModal()">&times;</button>
        </div>
        <form id="integrationForm" onsubmit="event.preventDefault(); saveIntegration();">
            <input type="hidden" id="integrationId" value="">
            <div class="form-group">
                <label for="integrationName">Name *</label>
                <input type="text" id="integrationName" class="form-control" placeholder="e.g., Production Prometheus"
                    required>
            </div>
            <div class="form-group">
                <label for="integrationType">Type *</label>
                <select id="integrationType" class="form-control" required onchange="updateConfigTemplate()">
                    <option value="">Select Type</option>
                    <option value="PROMETHEUS">Prometheus</option>
                    <option value="GRAFANA">Grafana</option>
                    <option value="ALERTMANAGER">Alertmanager</option>
                    <option value="LOKI">Grafana Loki</option>
                    <option value="STACKSTORM">StackStorm</option>
                    <option value="SLACK">Slack</option>
                    <option value="PAGERDUTY">PagerDuty</option>
                    <option value="JIRA">Jira</option>
                    <option value="SERVICENOW">ServiceNow</option>
                </select>
            </div>
            <div class="form-group">
                <label for="integrationConfig">Configuration (JSON)</label>
                <div class="config-input-group">
                    <textarea id="integrationConfig" class="form-control" rows="6"
                        placeholder='{"url": "http://...", "apiKey": "..."}'>{}</textarea>
                    <div class="config-actions">
                        <label class="btn btn-outline btn-sm upload-btn">
                            <i class="fas fa-upload"></i> Upload JSON
                            <input type="file" id="configFileUpload" accept=".json" style="display: none;"
                                onchange="handleConfigUpload(event)">
                        </label>
                        <button type="button" class="btn btn-outline btn-sm" onclick="formatConfig()">
                            <i class="fas fa-indent"></i> Format
                        </button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="validateConfig()">
                            <i class="fas fa-check-circle"></i> Validate
                        </button>
                    </div>
                </div>
                <div id="configHelp" class="config-help"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeIntegrationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Integration</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .integration-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .integration-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 0.75rem;
    }

    .integration-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .integration-linkedeye {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, #1e40af) 100%);
    }

    .integration-prometheus {
        background: #e6522c;
    }

    .integration-grafana {
        background: #f46800;
    }

    .integration-slack {
        background: #4a154b;
    }

    .integration-alertmanager {
        background: #f85149;
    }

    .integration-loki {
        background: linear-gradient(135deg, #f46800 0%, #ffc107 100%);
    }

    .integration-stackstorm {
        background: linear-gradient(135deg, #00c853 0%, #1de9b6 100%);
    }

    .integration-pagerduty {
        background: #06ac38;
    }

    .integration-jira {
        background: #0052cc;
    }

    .integration-servicenow {
        background: #81b5a1;
    }

    .integration-card.featured {
        border: 2px solid var(--primary);
        background: linear-gradient(135deg, rgba(var(--primary-rgb, 59, 130, 246), 0.05) 0%, white 100%);
    }

    .integration-card.featured .btn-primary {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .integration-info h4 {
        margin: 0;
        font-size: 1rem;
    }

    .integration-info p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    .mt-4 {
        margin-top: 1.5rem;
    }

    .live-metrics {
        background: var(--gray-50);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-top: 1rem;
    }

    .live-metrics h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        color: var(--gray-700);
    }

    .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--gray-200);
    }

    .metric-row:last-child {
        border-bottom: none;
    }

    .metric-label {
        color: var(--gray-600);
    }

    .metric-value {
        font-weight: 600;
    }

    .metric-value.up {
        color: var(--success);
    }

    .metric-value.down {
        color: var(--danger);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-500);
        line-height: 1;
    }

    .modal-close:hover {
        color: var(--gray-700);
    }

    #integrationForm {
        padding: 1.5rem;
    }

    #integrationForm .form-group {
        margin-bottom: 1rem;
    }

    #integrationForm label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--gray-700);
    }

    #integrationForm .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
    }

    #integrationForm textarea.form-control {
        font-family: monospace;
        font-size: 0.85rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
        margin-top: 1rem;
    }

    .text-success {
        color: var(--success);
    }

    .text-danger {
        color: var(--danger);
    }

    /* Integration card actions */
    .integration-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        padding: 0.35rem 0.75rem;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.8rem;
    }

    .btn-outline:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    /* Config input group */
    .config-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .config-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .upload-btn {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .config-help {
        font-size: 0.8rem;
        color: var(--gray-600);
        margin-top: 0.25rem;
        padding: 0.5rem;
        background: var(--gray-50);
        border-radius: var(--radius-sm);
        display: none;
    }

    .config-help.show {
        display: block;
    }

    .config-help.error {
        background: #fee2e2;
        color: #dc2626;
    }

    .config-help.success {
        background: #d1fae5;
        color: #059669;
    }

    .config-help.info {
        background: #dbeafe;
        color: #2563eb;
    }

    .config-help pre {
        margin: 0.5rem 0 0;
        padding: 0.5rem;
        background: white;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadLiveMetrics();
        // Refresh every 30 seconds
        setInterval(loadLiveMetrics, 30000);
    });

    async function loadLiveMetrics() {
        try {
            // Load Prometheus metrics
            const prometheusCard = document.querySelector('.integration-prometheus').closest('.integration-card');
            const promMetrics = await fetchPrometheusMetrics();
            updateMetricsDisplay(prometheusCard, promMetrics, 'prometheus');

            // Load Alertmanager alerts
            const alertsData = await fetchAlertmanagerAlerts();
            updateAlertsCount(alertsData);

        } catch (error) {
            console.error('Error loading live metrics:', error);
        }
    }

    async function fetchPrometheusMetrics() {
        const response = await fetch('/api/proxy/integrations/prometheus/targets');
        if (response.ok) {
            const data = await response.json();
            return data.data || {};
        }
        return {};
    }

    async function fetchAlertmanagerAlerts() {
        const response = await fetch('/api/proxy/integrations/alertmanager/alerts');
        if (response.ok) {
            const data = await response.json();
            return data.data || [];
        }
        return [];
    }

    function updateMetricsDisplay(card, metrics, type) {
        let metricsDiv = card.querySelector('.live-metrics');
        if (!metricsDiv) {
            metricsDiv = document.createElement('div');
            metricsDiv.className = 'live-metrics';
            card.appendChild(metricsDiv);
        }

        if (type === 'prometheus' && metrics.activeTargets) {
            const upCount = metrics.activeTargets.filter(t => t.health === 'up').length;
            const downCount = metrics.activeTargets.filter(t => t.health === 'down').length;
            metricsDiv.innerHTML = `
            <h4><i class="fas fa-chart-bar"></i> Live Status</h4>
            <div class="metric-row">
                <span class="metric-label">Targets Up</span>
                <span class="metric-value up">${upCount}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Targets Down</span>
                <span class="metric-value ${downCount > 0 ? 'down' : ''}">${downCount}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Total Targets</span>
                <span class="metric-value">${metrics.activeTargets.length}</span>
            </div>
        `;
        }
    }

    function updateAlertsCount(alerts) {
        const alertmanagerStatus = document.getElementById('alertmanager-status');
        if (alertmanagerStatus) {
            const firingCount = alerts.filter(a => a.status?.state === 'active').length;
            if (firingCount > 0) {
                alertmanagerStatus.innerHTML = `<span class="badge badge-danger">${firingCount} Active</span>`;
            } else {
                alertmanagerStatus.innerHTML = '<span class="badge badge-success">Connected</span>';
            }
        }
    }

    async function testIntegration(type) {
        const btn = event.target;
        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';

        try {
            const response = await fetch(`/api/proxy/integrations/${type}/test`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check"></i> Connected';
                btn.classList.add('btn-success');
            } else {
                btn.innerHTML = '<i class="fas fa-times"></i> Failed';
                btn.classList.add('btn-danger');
            }
        } catch (error) {
            btn.innerHTML = '<i class="fas fa-times"></i> Error';
            btn.classList.add('btn-danger');
        }

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success', 'btn-danger');
        }, 3000);
    }

    async function syncIntegration(type) {
        const btn = event.target;
        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

        try {
            const response = await fetch(`/api/proxy/integrations/${type}/sync`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check"></i> Done';
                btn.classList.add('btn-success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                alert('Sync failed: ' + (data.error || 'Unknown error'));
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        } catch (error) {
            alert('Error triggering sync: ' + error.message);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Configuration templates for each integration type
    const configTemplates = {
        PROMETHEUS: {
            url: "http://prometheus:9090",
            basicAuth: {
                username: "",
                password: ""
            }
        },
        GRAFANA: {
            url: "http://grafana:3000",
            apiKey: "",
            orgId: 1
        },
        ALERTMANAGER: {
            url: "http://alertmanager:9093",
            basicAuth: {
                username: "",
                password: ""
            }
        },
        LOKI: {
            url: "http://loki:3100",
            apiKey: "",
            tenantId: ""
        },
        STACKSTORM: {
            url: "https://stackstorm:443",
            apiKey: "",
            authToken: ""
        },
        SLACK: {
            webhookUrl: "https://hooks.slack.com/services/...",
            channel: "#alerts",
            username: "LinkedEye Bot"
        },
        PAGERDUTY: {
            routingKey: "",
            serviceKey: "",
            apiKey: ""
        },
        JIRA: {
            url: "https://yourcompany.atlassian.net",
            email: "",
            apiToken: "",
            projectKey: ""
        },
        SERVICENOW: {
            url: "https://yourinstance.service-now.com",
            username: "",
            password: "",
            clientId: "",
            clientSecret: ""
        }
    };

    function showAddIntegration() {
        document.getElementById('integrationModalTitle').textContent = 'Add Integration';
        document.getElementById('integrationForm').reset();
        document.getElementById('integrationId').value = '';
        document.getElementById('integrationConfig').value = '{}';
        hideConfigHelp();
        document.getElementById('integrationModal').style.display = 'flex';
    }

    function configureIntegration(type, id, name, config) {
        if (id) {
            // Editing existing integration
            document.getElementById('integrationModalTitle').textContent = 'Configure ' + type;
            document.getElementById('integrationId').value = id;
            document.getElementById('integrationName').value = name || type;
            document.getElementById('integrationType').value = type;
            try {
                const configObj = typeof config === 'string' ? JSON.parse(config) : config;
                document.getElementById('integrationConfig').value = JSON.stringify(configObj, null, 2);
            } catch (e) {
                document.getElementById('integrationConfig').value = config || '{}';
            }
        } else {
            // Setting up new integration
            document.getElementById('integrationModalTitle').textContent = 'Setup ' + type;
            document.getElementById('integrationForm').reset();
            document.getElementById('integrationId').value = '';
            document.getElementById('integrationName').value = type + ' Integration';
            document.getElementById('integrationType').value = type;
            // Load template config
            const template = configTemplates[type] || {};
            document.getElementById('integrationConfig').value = JSON.stringify(template, null, 2);
        }
        updateConfigTemplate();
        document.getElementById('integrationModal').style.display = 'flex';
    }

    function editIntegration(id, name, type, config) {
        document.getElementById('integrationModalTitle').textContent = 'Edit Integration';
        document.getElementById('integrationId').value = id;
        document.getElementById('integrationName').value = name;
        document.getElementById('integrationType').value = type;
        try {
            const configObj = typeof config === 'string' ? JSON.parse(config) : config;
            document.getElementById('integrationConfig').value = JSON.stringify(configObj, null, 2);
        } catch (e) {
            document.getElementById('integrationConfig').value = config || '{}';
        }
        updateConfigTemplate();
        document.getElementById('integrationModal').style.display = 'flex';
    }

    function closeIntegrationModal() {
        document.getElementById('integrationModal').style.display = 'none';
        hideConfigHelp();
    }

    function updateConfigTemplate() {
        const type = document.getElementById('integrationType').value;
        const configTextarea = document.getElementById('integrationConfig');
        const helpDiv = document.getElementById('configHelp');

        if (type && configTemplates[type]) {
            // Only update if the current config is empty or just {}
            const currentConfig = configTextarea.value.trim();
            if (currentConfig === '' || currentConfig === '{}') {
                configTextarea.value = JSON.stringify(configTemplates[type], null, 2);
            }

            // Show help text
            showConfigHelp('info', getConfigHelpText(type));
        }
    }

    function getConfigHelpText(type) {
        const helpTexts = {
            PROMETHEUS: 'Required: url. Optional: basicAuth (username, password)',
            GRAFANA: 'Required: url, apiKey. Optional: orgId',
            ALERTMANAGER: 'Required: url. Optional: basicAuth',
            LOKI: 'Required: url. Optional: apiKey, tenantId',
            STACKSTORM: 'Required: url, apiKey. Optional: authToken',
            SLACK: 'Required: webhookUrl. Optional: channel, username',
            PAGERDUTY: 'Required: routingKey or serviceKey',
            JIRA: 'Required: url, email, apiToken, projectKey',
            SERVICENOW: 'Required: url, username, password. Optional: clientId, clientSecret'
        };
        return helpTexts[type] || '';
    }

    function handleConfigUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const json = JSON.parse(e.target.result);
                document.getElementById('integrationConfig').value = JSON.stringify(json, null, 2);
                showConfigHelp('success', 'Configuration file loaded successfully');
            } catch (err) {
                showConfigHelp('error', 'Invalid JSON file: ' + err.message);
            }
        };
        reader.readAsText(file);

        // Reset file input
        event.target.value = '';
    }

    function formatConfig() {
        const textarea = document.getElementById('integrationConfig');
        try {
            const json = JSON.parse(textarea.value);
            textarea.value = JSON.stringify(json, null, 2);
            showConfigHelp('success', 'Configuration formatted successfully');
        } catch (err) {
            showConfigHelp('error', 'Invalid JSON: ' + err.message);
        }
    }

    function validateConfig() {
        const textarea = document.getElementById('integrationConfig');
        const type = document.getElementById('integrationType').value;

        try {
            const json = JSON.parse(textarea.value);

            // Basic validation based on type
            const requiredFields = {
                PROMETHEUS: ['url'],
                GRAFANA: ['url'],
                ALERTMANAGER: ['url'],
                LOKI: ['url'],
                STACKSTORM: ['url', 'apiKey'],
                SLACK: ['webhookUrl'],
                PAGERDUTY: ['routingKey'],
                JIRA: ['url', 'email', 'apiToken'],
                SERVICENOW: ['url', 'username', 'password']
            };

            const required = requiredFields[type] || [];
            const missing = required.filter(field => !json[field]);

            if (missing.length > 0) {
                showConfigHelp('error', 'Missing required fields: ' + missing.join(', '));
            } else {
                showConfigHelp('success', 'Configuration is valid!');
            }
        } catch (err) {
            showConfigHelp('error', 'Invalid JSON: ' + err.message);
        }
    }

    function showConfigHelp(type, message) {
        const helpDiv = document.getElementById('configHelp');
        helpDiv.className = 'config-help show ' + type;
        helpDiv.textContent = message;
    }

    function hideConfigHelp() {
        const helpDiv = document.getElementById('configHelp');
        helpDiv.className = 'config-help';
        helpDiv.textContent = '';
    }

    async function saveIntegration() {
        const id = document.getElementById('integrationId').value;
        const name = document.getElementById('integrationName').value;
        const type = document.getElementById('integrationType').value;
        const configText = document.getElementById('integrationConfig').value;

        if (!name || !type) {
            alert('Please fill in all required fields');
            return;
        }

        let config;
        try {
            config = JSON.parse(configText || '{}');
        } catch (e) {
            alert('Invalid JSON in configuration field');
            return;
        }

        const saveBtn = document.querySelector('#integrationForm button[type="submit"]');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
            const url = id ? `/api/proxy/integrations/${id}` : '/api/proxy/integrations';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type, config })
            });

            const data = await response.json();

            if (data.success) {
                closeIntegrationModal();
                window.location.reload();
            } else {
                alert('Failed to save integration: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error saving integration: ' + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save Integration';
        }
    }

    async function testIntegrationById(id) {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const response = await fetch(`/api/proxy/integrations/${id}/test`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check text-success"></i>';
            } else {
                btn.innerHTML = '<i class="fas fa-times text-danger"></i>';
                alert('Connection test failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            btn.innerHTML = '<i class="fas fa-times text-danger"></i>';
            alert('Error testing integration: ' + error.message);
        }

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    async function deleteIntegration(id) {
        if (!confirm('Are you sure you want to delete this integration?')) {
            return;
        }

        try {
            const response = await fetch(`/api/proxy/integrations/${id}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (data.success) {
                window.location.reload();
            } else {
                alert('Failed to delete integration: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error deleting integration: ' + error.message);
        }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('integrationModal');
        if (e.target === modal) {
            closeIntegrationModal();
        }
    });
</script>
{% endblock %}