{% extends "base.html" %}

{% block body_class %}app-layout{% endblock %}

{% block body %}
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">LE</div>
                <div class="sidebar-logo-text">
                    <span class="logo-primary">LinkedEye</span>
                    <span class="logo-secondary">FinSpot</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <!-- RUN Section -->
            <div class="nav-section">
                <div class="nav-section-title">
                    <span class="rot-badge rot-run">RUN</span>
                    Operations
                </div>

                <a href="{{ url_for('dashboard') }}" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <i class="nav-icon fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>

                <a href="{{ url_for('incidents_list') }}" class="nav-item {% if 'incident' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-exclamation-triangle"></i>
                    <span>Incidents</span>
                    {% if quick_stats and quick_stats.openIncidents %}
                    <span class="nav-badge">{{ quick_stats.openIncidents }}</span>
                    {% endif %}
                </a>

                <a href="#" class="nav-item">
                    <i class="nav-icon fas fa-bell"></i>
                    <span>Alerts</span>
                    {% if quick_stats and quick_stats.activeAlerts %}
                    <span class="nav-badge danger">{{ quick_stats.activeAlerts }}</span>
                    {% endif %}
                </a>

                <a href="{{ url_for('network_topology') }}" class="nav-item {% if 'network' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-network-wired"></i>
                    <span>Network</span>
                </a>
            </div>

            <!-- OPERATE Section -->
            <div class="nav-section">
                <div class="nav-section-title">
                    <span class="rot-badge rot-operate">OPERATE</span>
                    Control
                </div>

                <a href="{{ url_for('changes_list') }}" class="nav-item {% if 'change' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-exchange-alt"></i>
                    <span>Changes</span>
                    {% if quick_stats and quick_stats.pendingChanges %}
                    <span class="nav-badge warning">{{ quick_stats.pendingChanges }}</span>
                    {% endif %}
                </a>

                <a href="{{ url_for('problems_list') }}" class="nav-item {% if 'problem' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-bug"></i>
                    <span>Problems</span>
                </a>

                <a href="{{ url_for('assets_list') }}" class="nav-item {% if 'asset' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-server"></i>
                    <span>Assets / CMDB</span>
                </a>
            </div>

            <!-- TRANSFORM Section -->
            <div class="nav-section">
                <div class="nav-section-title">
                    <span class="rot-badge rot-transform">TRANSFORM</span>
                    Intelligence
                </div>

                <a href="{{ url_for('reports') }}" class="nav-item {% if 'report' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>

                <a href="{{ url_for('ai_insights') }}" class="nav-item {% if 'ai' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-brain"></i>
                    <span>AI Insights</span>
                </a>
            </div>

            <!-- Management Section -->
            <div class="nav-section">
                <div class="nav-section-title">Management</div>

                <a href="{{ url_for('users_list') }}" class="nav-item {% if 'user' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-users"></i>
                    <span>Users & Teams</span>
                </a>

                <a href="{{ url_for('on_call') }}" class="nav-item {% if 'on_call' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-phone"></i>
                    <span>On-Call</span>
                </a>

                <a href="{{ url_for('integrations') }}" class="nav-item {% if 'integration' in request.endpoint %}active{% endif %}">
                    <i class="nav-icon fas fa-plug"></i>
                    <span>Integrations</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-version">v1.0.0</div>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search incidents, assets, changes... (Ctrl+K)" id="globalSearch">
                </div>
            </div>

            <div class="header-right">
                <div class="header-icon" id="refreshBtn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </div>

                <div class="header-icon" id="notificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">3</span>
                </div>

                <div class="header-icon" title="Help">
                    <i class="fas fa-question-circle"></i>
                </div>

                <div class="user-profile" id="userMenu">
                    <div class="user-avatar">{{ current_user.initials }}</div>
                    <div class="user-info">
                        <div class="user-name">{{ current_user.full_name }}</div>
                        <div class="user-role">{{ current_user.role }}</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>

                    <!-- Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{{ url_for('logout') }}" class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="page-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                        {{ message }}
                        <button class="alert-close">&times;</button>
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
        <h3>Notifications</h3>
        <button class="btn btn-text">Mark all read</button>
    </div>
    <div class="notification-list" id="notificationList">
        <!-- Notifications will be loaded here -->
    </div>
</div>

<!-- Quick Search Modal -->
<div class="modal" id="searchModal">
    <div class="modal-content search-modal">
        <div class="search-modal-input">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search..." id="quickSearchInput" autofocus>
            <kbd>ESC</kbd>
        </div>
        <div class="search-results" id="searchResults">
            <!-- Search results will be loaded here -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Global helper functions for notifications and stats refresh
    function showNotification(title, message, type) {
        // Use the Toast notification system from main.js
        if (window.LinkedEye && window.LinkedEye.Toast) {
            const fullMessage = message ? `${title}: ${message}` : title;
            window.LinkedEye.Toast.show(fullMessage, type || 'info');
        } else if (window.showToast) {
            const fullMessage = message ? `${title}: ${message}` : title;
            window.showToast(fullMessage, type || 'info');
        } else {
            console.log(`[${type || 'info'}] ${title}: ${message}`);
        }
    }

    function refreshStats() {
        // Refresh dashboard statistics if the function exists on the page
        if (typeof window.refreshDashboardStats === 'function') {
            window.refreshDashboardStats();
        }
        // Also trigger custom event for pages that listen
        document.dispatchEvent(new CustomEvent('linkedeye:refresh-stats'));
    }

    function updateNotificationBadge() {
        // Update notification badge count
        if (window.LinkedEye && window.LinkedEye.Notifications) {
            window.LinkedEye.Notifications.loadNotifications();
        }
    }

    // Initialize Socket.IO connection
    {% if current_user.is_authenticated %}
    const socket = io('http://localhost:5000', {
        auth: {
            token: '{{ session.get("access_token", "") }}'
        }
    });

    socket.on('connect', () => {
        console.log('WebSocket connected');
        socket.emit('subscribe:dashboard');
        socket.emit('subscribe:incidents');
        socket.emit('subscribe:alerts');
    });

    socket.on('incident:created', (incident) => {
        showNotification(`New Incident: ${incident.number}`, incident.shortDescription, 'info');
        refreshStats();
    });

    socket.on('incident:updated', (incident) => {
        refreshStats();
    });

    socket.on('alert:received', (alert) => {
        showNotification(`Alert: ${alert.name}`, alert.description, alert.severity.toLowerCase());
        refreshStats();
    });

    socket.on('notification:new', (notification) => {
        showNotification(notification.title, notification.message, 'info');
        updateNotificationBadge();
    });
    {% endif %}
</script>
{% endblock %}
